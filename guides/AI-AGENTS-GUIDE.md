# AI Coding Agents Guide

This guide covers the AI coding agents available in your workflow — configuration, secrets, logging, and orchestration.

---

## Overview

Four CLI tools for AI-assisted development, all configured declaratively via `home-manager/modules/ai-agents/`:

| Agent | Binary | Config Location | Format |
|-------|--------|----------------|--------|
| **Claude Code** | `claude` | `~/.claude/settings.json` + `~/.mcp.json` | JSON |
| **OpenCode** | `opencode` | `~/.config/opencode/opencode.json` | JSON |
| **Gemini CLI** | `gemini` | `~/.gemini/settings.json` | JSON |
| **Codex** | `codex` | `~/.codex/config.toml` | TOML |

All configs are generated by Nix and patched with sops secrets at `just home` activation time.

---

## Shell Aliases & Functions

### Quick Reference

| Alias/Function | What It Runs | Notes |
|----------------|-------------|-------|
| `cl` | `claude` | Default Claude Code interactive session |
| `oc` | `opencode` | Default OpenCode |
| `oc-tmux` | OpenCode in tmux with visual multi-agent | Function: finds free port, spawns tmux session |
| `claude_glm` (`clg`) | Claude Code via Z.AI GLM-5 proxy | Function: sets ANTHROPIC base URL + GLM model env vars |
| `opencode_glm` (`ocg`) | OpenCode with GLM-5 profile | Function: sets `OPENCODE_CONFIG_DIR=~/.config/opencode-glm/` |
| `opencode_gemini` (`ocgem`) | OpenCode with Gemini Antigravity profile | Function: sets `OPENCODE_CONFIG_DIR=~/.config/opencode-gemini/` |
| `oc-sops` | OpenCode with Z.AI key from sops | Function: injects Z_AI_API_KEY |
| `cl-sops` | Claude Code with Z.AI key from sops | Function: injects Z_AI_API_KEY |
| `occm` | `opencode '<review/split/sign prompt>'` | Review current git changes and commit logically with `git commit -S` |
| `cx` | `codex --no-alt-screen` | Zellij-friendly Codex |
| `cxyolo` | `codex --no-alt-screen --dangerously-bypass-approvals-and-sandbox` | Fully unrestricted Codex (risky) |
| `cxquick` | `codex --no-alt-screen -p quick` | Codex quick profile |
| `cxdeep` | `codex --no-alt-screen -p deep` | Codex deep profile |
| `cxsafe` | `codex --no-alt-screen -p safe` | Codex safe profile |

### Aliases vs Functions

- **Aliases** (`cl`, `oc`, `cx`, `cxquick`, `occm`, etc.) are defined in `home-manager/modules/terminal/zsh/aliases.nix` as simple command mappings.
- **Functions** (`claude_glm`, `opencode_glm`, `opencode_gemini`, `oc-sops`, `cl-sops`, `oc-tmux`) are defined in `home-manager/modules/terminal/zsh/default.nix` for env var injection, sops key loading, or multi-line logic.

---

## Configuration Architecture

```
ai-agents/
├── default.nix      # Module options, activation scripts, config generation
├── config.nix       # Actual values (models, MCP servers, hooks, settings)
└── log-analyzer.nix # Log analysis tools and dashboard
```

### How It Works

1. **Nix generates** base configs from `config.nix` values
2. **Activation scripts** write configs as real files (not symlinks, so plugins can modify)
3. **`patchAiAgentSecrets`** injects the Z.AI API key into all agents + both OpenCode profiles from sops
4. Agents read their native config files at runtime

---

## Agent Settings

### Claude Code

| Setting | Value | Why |
|---------|-------|-----|
| Model | `opus` | Best quality for primary coding |
| Extended thinking | Always on | Better reasoning by default |
| Tool search | `auto:5` | Auto-search when >5 tools match (faster with many MCPs) |
| Auto-updates | `stable` channel | Week-old releases, skips regressions |
| Cleanup | 14 days | Auto-delete old sessions |
| Attribution | Disabled | No auto-attribution in commits/PRs |
| Turn duration | Shown | "Cooked for Xm Ys" feedback |

Permissions allow: `git`, `gh`, `npm run`, `pnpm`, `bun`, `just`, `nix`, `cargo`, `docker`, etc. Deny: `rm -rf /`, `rm -rf ~`, disk operations (`dd`, `mkfs`), `.env` files, `./secrets/`, SSH keys.

### OpenCode

| Setting | Value | Why |
|---------|-------|-----|
| Model | `anthropic/claude-opus-4-6` | Primary coding model |
| Theme | `gruvbox` | Matches system theme |
| Small model | `claude-haiku-4-5` | Cheap model for titles, summaries |
| Compaction | Auto + prune | Remove old tool outputs, reserve 10k tokens |
| Custom commands | test, deploy, review | Workflow shortcuts via `/test`, `/deploy`, `/review` |
| Plugins | oh-my-opencode, antigravity-auth, anthropic-auth | Multi-provider access |

### Gemini CLI

| Setting | Value | Why |
|---------|-------|-----|
| Theme | `Default` | Standard Gemini theme |
| Vim mode | Enabled | Consistent with Neovim workflow |
| Auto-update | Disabled | Nix manages versions |
| Session retention | 30 days | Auto-cleanup old sessions |
| Checkpointing | Enabled | Session recovery on crash |
| Privacy/telemetry | Disabled | Privacy-conscious |
| Tips/banner | Hidden | Clean interface |
| Code execution | Enabled | Run code in sandbox |
| Search grounding | Enabled | Web-grounded responses |

### Codex

| Setting | Value | Why |
|---------|-------|-----|
| Model | `gpt-5.3-codex` | Latest Codex model |
| Personality | `pragmatic` | Direct, practical responses |
| Reasoning effort | `medium` | Balanced speed/quality |
| Approval policy | `on-request` | Model decides when to ask |
| Web search | `live` | Real-time web access |
| Update check | Disabled | Nix manages versions |
| History | `save-all` | Persistent session history |
| Feature: request_rule | Enabled | Smart approval suggestions |
| Profiles | nix, review, quick, deep, safe | Context-switching presets |
| Shell env policy | `core` | Exclude secrets/tokens from env |

Trusted projects: `~/System`.

---

## oh-my-opencode Agents (Default Profile)

| Agent | Model | Purpose |
|-------|-------|---------|
| sisyphus | claude-opus-4-6 | Primary orchestrator, delegates work |
| hephaestus | claude-opus-4-6 | Autonomous deep worker |
| oracle | claude-opus-4-6 | Read-only consultant for architecture |
| prometheus | claude-opus-4-6/max | Deep thinking with extended budget |
| metis | claude-opus-4-6 | Pre-planning analysis |
| librarian | claude-sonnet-4-5 | Documentation and reference search |
| atlas | claude-sonnet-4-5 | Codebase exploration |
| momus | gpt-5.2 | Plan review and QA |
| explore | claude-haiku-4-5 | Quick contextual grep |
| multimodal-looker | gemini-3-flash | Visual analysis |

### oh-my-opencode Category Models

| Category | Model | Use Case |
|----------|-------|----------|
| visual-engineering | antigravity-gemini-3-pro | Frontend, UI/UX, design, styling |
| ultrabrain | gpt-5.3-codex | Deep logical reasoning, complex architecture |
| deep | claude-opus-4-6 (max) | Goal-oriented autonomous problem-solving |
| artistry | antigravity-gemini-3-pro | Creative, unconventional approaches |
| quick | claude-haiku-4-5 | Trivial tasks, typo fixes |
| unspecified-low | claude-sonnet-4-5 | General tasks, low effort |
| unspecified-high | claude-opus-4-6 (max) | General tasks, high effort |
| writing | antigravity-gemini-3-flash | Documentation, prose |

### oh-my-opencode Features

| Feature | Value | Why |
|---------|-------|-----|
| Tmux visual multi-agent | Enabled | See agents work in separate panes |
| Stale task timeout | 180s | Kill hung background tasks |
| Aggressive truncation | Enabled | Save tokens on large outputs |
| Preemptive compaction | Enabled | Compact before hitting limits |
| Disabled hooks | agent-usage-reminder, startup-toast | Reduce noise |

---

## GLM-5 Profile (`opencode_glm` / `claude_glm`)

Z.AI GLM-5 as primary model for cost-effective coding sessions. Two entry points:

### `opencode_glm` (`ocg`) — OpenCode with GLM-5

Uses a separate config directory (`~/.config/opencode-glm/`) with all models overridden to GLM variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent | GLM Model | Tier |
|-------|-----------|------|
| sisyphus | zai-coding-plan/glm-5 | Heavy |
| hephaestus | zai-coding-plan/glm-5 | Heavy |
| oracle | zai-coding-plan/glm-5 | Heavy |
| prometheus | zai-coding-plan/glm-5 | Heavy |
| metis | zai-coding-plan/glm-5 | Heavy |
| librarian | zai-coding-plan/glm-4.7 | Standard |
| momus | zai-coding-plan/glm-4.7 | Standard |
| atlas | zai-coding-plan/glm-4.7 | Standard |
| explore | zai-coding-plan/glm-4.7-flash | Fast |
| multimodal-looker | google/gemini-3-flash | Vision (unchanged) |

Category overrides:

| Category | Model |
|----------|-------|
| visual-engineering, ultrabrain, deep, artistry, unspecified-high | glm-5 |
| unspecified-low, writing | glm-4.7 |
| quick | glm-4.7-flash |

### `claude_glm` (`clg`) — Claude Code via Z.AI GLM-5

Routes through Z.AI's Anthropic-compatible proxy (`https://api.z.ai/api/anthropic`).

| Env Var | Value |
|---------|-------|
| `ANTHROPIC_AUTH_TOKEN` | Z.AI API key (from sops) |
| `ANTHROPIC_BASE_URL` | `https://api.z.ai/api/anthropic` |
| `API_TIMEOUT_MS` | `3000000` (50 min, per Z.AI docs) |
| `ANTHROPIC_DEFAULT_HAIKU_MODEL` | `glm-4.5-air` |
| `ANTHROPIC_DEFAULT_SONNET_MODEL` | `glm-5` |
| `ANTHROPIC_DEFAULT_OPUS_MODEL` | `glm-5` |

Also passes `--dangerously-skip-permissions` for autonomous operation.

### GLM Model Reference

| Model ID | Parameters | Context | Use Case |
|----------|-----------|---------|----------|
| glm-5 | 744B (40B active MoE) | 200K | Flagship reasoning |
| glm-4.7 | — | — | Previous gen, stable coding |
| glm-4.7-flash | — | — | Fast/cheap variant |
| glm-4.5-air | — | — | Lightest, haiku tier |
| glm-4.6v | — | — | Vision variant |

Provider prefixes: `zai-coding-plan/` (premium), `zai/` (standard), `opencode/` (free tier).

---

## Gemini Antigravity Profile (`opencode_gemini`)

Google Gemini models via Antigravity as primary models for Gemini-native coding sessions. Uses the `opencode-antigravity-auth` plugin for authentication.

### `opencode_gemini` (`ocgem`) — OpenCode with Gemini Antigravity

Uses a separate config directory (`~/.config/opencode-gemini/`) with all models overridden to Gemini Antigravity variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent | Gemini Model | Variant | Tier |
|-------|-------------|---------|------|
| sisyphus | antigravity-gemini-3-pro | — | Heavy |
| hephaestus | antigravity-gemini-3-pro | — | Heavy |
| oracle | antigravity-gemini-3-pro | — | Heavy |
| prometheus | antigravity-gemini-3-pro | high | Heavy (max thinking) |
| metis | antigravity-gemini-3-pro | — | Heavy |
| momus | antigravity-gemini-3-pro | low | Heavy (light thinking) |
| librarian | antigravity-gemini-3-flash | medium | Fast |
| atlas | antigravity-gemini-3-flash | medium | Fast |
| explore | antigravity-gemini-3-flash | minimal | Fast (speed priority) |
| multimodal-looker | gemini-3-flash | — | Vision (unchanged) |

Category overrides:

| Category | Model | Variant |
|----------|-------|---------|
| visual-engineering | antigravity-gemini-3-pro | — |
| ultrabrain | antigravity-gemini-3-pro | high |
| deep | antigravity-gemini-3-pro | high |
| artistry | antigravity-gemini-3-pro | — |
| unspecified-high | antigravity-gemini-3-pro | high |
| unspecified-low | antigravity-gemini-3-flash | medium |
| writing | antigravity-gemini-3-flash | medium |
| quick | antigravity-gemini-3-flash | minimal |

### Gemini Antigravity Model Reference

| Model ID | Context | Thinking Variants | Use Case |
|----------|---------|-------------------|----------|
| antigravity-gemini-3-pro | 1M | low, high | Flagship reasoning, coding, architecture |
| antigravity-gemini-3-flash | 1M | minimal, low, medium, high | Fast coding, search, writing |
| gemini-3-flash | — | — | Vision, multimodal analysis |

---

## oh-my-claudecode (Claude Code Plugin)

Installed automatically via activation script. Provides multi-agent orchestration.

### Execution Modes

| Mode | Description |
|------|-------------|
| autopilot | Default automation with safe pacing |
| ultrawork | Aggressive parallel execution |
| ralph | Persistent execution until done |
| ultrapilot | High-agency automation |
| ecomode | Token-efficient execution |
| swarm | Multi-agent style execution |
| pipeline | Sequential pipeline stages |

### Magic Keywords

| Keyword | Meaning |
|---------|---------|
| ultrawork / ulw | Maximum parallelism |
| ralph | Persistent execution until done |
| eco | Token-efficient mode |
| plan | Planning interview |

---

## MCP Servers

Defined once in `config.nix`, shared across Claude Code, OpenCode, Gemini CLI, and Codex.

| Server | Purpose | Status |
|--------|---------|--------|
| context7 | Library documentation context | Enabled (all agents) |
| memory | Persistent knowledge graph across sessions | Enabled (all agents) |
| sequential-thinking | Step-by-step reasoning with backtracking | Enabled (all agents) |
| zai-mcp-server | Z.AI tools (key injected from sops) | Enabled (all agents) |
| playwright | Browser automation and testing | Enabled (all agents) |
| filesystem | Project filesystem access | Enabled (all agents) |
| git | Git repository operations | Enabled (all agents) |
| github | GitHub API (issues, PRs, code search) | Enabled (all agents) |
| cloudflare-docs | Cloudflare documentation search | Enabled (remote) |
| web-search-prime | Web search via Z.AI | Injected at activation |
| web-reader | Read web pages via Z.AI | Injected at activation |
| zread | Document reader via Z.AI | Injected (Claude/OpenCode only) |

Remote MCP servers are injected into all 4 agents by `patchAiAgentSecrets` using the sops-decrypted Z.AI API key.

---

## Claude Code Hooks (Auto-Format)

PostToolUse hooks auto-format files after edits:

| Language | Formatter |
|----------|-----------|
| TypeScript/JavaScript/JSON | biome |
| Rust | rustfmt |
| Zig | zig fmt |
| Go | gofmt |
| Nix | nixfmt |
| Python | ruff format |
| YAML/TOML | prettier |

A PreToolUse hook warns before destructive bash commands (`rm -rf`, `DROP`, `DELETE FROM`, `truncate`).

---

## Sops Secrets Integration

API keys are managed via sops-nix (age-encrypted). The Z.AI API key lives at `/run/secrets/zai_api_key`.

### Shell Functions (sops-enabled)

| Function | What It Does |
|----------|-------------|
| `oc-sops` | Launch OpenCode with Z_AI_API_KEY from sops |
| `cl-sops` | Launch Claude Code with Z_AI_API_KEY from sops |
| `claude_glm` (`clg`) | Claude Code via Z.AI proxy (GLM-5 models + skip-permissions) |
| `opencode_glm` (`ocg`) | OpenCode with GLM-5 profile (separate config dir) |
| `opencode_gemini` (`ocgem`) | OpenCode with Gemini Antigravity profile (separate config dir) |

All sops functions use `_load_zai_key()` which reads `/run/secrets/zai_api_key`. If the file is missing, run `just nixos` to decrypt secrets.

### Activation Patching

`just home` runs `patchAiAgentSecrets` which injects the Z.AI API key into:

1. `~/.config/opencode/opencode.json` — MCP server env + remote MCPs
2. `~/.config/opencode-glm/opencode.json` — GLM profile MCP server env + remote MCPs
3. `~/.mcp.json` — Claude Code MCP server env + remote MCPs
4. `~/.codex/config.toml` — MCP server env
5. `~/.gemini/settings.json` — MCP server env + remote MCPs

---

## Logging & Monitoring

### Real Log Locations

| Agent | Log Path |
|-------|----------|
| OpenCode | `~/.local/share/opencode/log/*.log` |
| Codex | `~/.codex/log/codex-tui.log` |
| Claude Code | Enable with `ANTHROPIC_LOG=debug` env var |
| Gemini CLI | No persistent logs by default |

### Commands

| Alias | What It Does |
|-------|-------------|
| `ai-logs` | Tail real OpenCode + Codex logs |
| `ai-errors` | Grep for errors/panics/fatals in agent logs |
| `ai-stats` | Log statistics summary (wrapper-based) |
| `ai-report` | Full analysis report |
| `ai-dash` | Interactive fzf dashboard |

### Wrapper Logging (Optional)

Use `*-log` aliases for explicit logged sessions through the wrapper:

| Alias | Runs |
|-------|------|
| `cl-log` | `ai-agent-log-wrapper claude claude` |
| `oc-log` | `ai-agent-log-wrapper opencode opencode` |
| `codex-log` | `ai-agent-log-wrapper codex codex` |
| `gemini-log` | `ai-agent-log-wrapper gemini gemini` |

Wrapper logs go to `~/.local/share/ai-agents/logs/`. Log cleanup runs weekly (30-day retention) via systemd user timer.

---

## Best Practices

| Practice | Why It Helps |
|----------|--------------|
| Delegate when the task splits cleanly | Reduces context switching and speeds execution |
| Do directly when the task is tightly coupled | Avoids coordination overhead |
| Parallelize independent tasks | Maximizes throughput and reduces total time |
| Keep background tasks running | Useful for long-running fetches or builds |
| Use explicit roles | Prevents overlap and clarifies ownership |

### Quick Patterns

```text
Task is independent?  -> delegate or run in parallel
Task is sequential?   -> keep in a single agent
Need deep analysis?   -> route to prometheus or oracle
Need fast scans?      -> route to explore or atlas
```

### Agent Selection

```text
Simple question       -> claude or gemini (direct)
Coding task           -> claude (opus) or opencode (gpt-5.2-codex)
GLM-5 coding          -> opencode_glm (alias: ocg) or claude_glm (alias: clg)
Gemini coding         -> opencode_gemini (alias: ocgem)
Codex profiles        -> cxquick (fast), cxdeep (thorough), cxsafe (guard-railed)
Quick prototype       -> codex (pragmatic personality)
Research + docs       -> gemini (search grounding) or librarian agent
Multi-file refactor   -> claude with oh-my-claudecode ultrawork mode
```
