# AI Coding Agents Guide

This guide covers the AI coding agents available in your workflow — configuration, secrets, logging, and orchestration.

---

## Overview

Four CLI tools for AI-assisted development, all configured declaratively via `home-manager/modules/ai-agents/`:

| Agent | Binary | Config Location | Format |
|-------|--------|----------------|--------|
| **Claude Code** | `claude` | `~/.claude/settings.json` + `~/.mcp.json` | JSON |
| **OpenCode** | `opencode` | `~/.config/opencode/opencode.json` | JSON |
| **Gemini CLI** | `gemini` | `~/.gemini/settings.json` | JSON |
| **Codex** | `codex` | `~/.codex/config.toml` | TOML |

All configs are generated by Nix and patched with sops secrets at `just home` activation time.

---

## Shell Aliases & Functions

### Quick Reference

| Alias/Function | What It Runs | Notes |
|----------------|-------------|-------|
| `cl` | `claude --dangerously-skip-permissions` | Default Claude Code (skip permissions) |
| `oc` | `opencode` | Default OpenCode |
| `clg` | Claude Code via Z.AI GLM-5 proxy | Function: sets ANTHROPIC_BASE_URL + model env vars |
| `ocg` | OpenCode with GLM-5 profile | Function: sets OPENCODE_CONFIG_DIR to `~/.config/opencode-glm/` |
| `oc-sops` | OpenCode with Z.AI key from sops | Function: injects Z_AI_API_KEY |
| `cl-sops` | Claude Code with Z.AI key from sops | Function: injects Z_AI_API_KEY |
| `qq` | `claude` with haiku model | Quick cheap questions |
| `deep` | `claude` with opus model | Deep thinking tasks |
| `fix` | Pipe last command error to Claude | Auto-fix errors |
| `nix-fix` | Pipe `just check` errors to Claude | Auto-fix Nix eval errors |
| `ac` | `ai-commit` | AI-generated commit messages |
| `ak` | `ai-ask` | Quick AI question (Z.AI) |
| `ah` | `ai-help` | AI help (Z.AI) |
| `rmx` | `repomix` | Bundle repo for AI context |
| `rmx-clip` | `repomix --copy` | Bundle repo to clipboard |
| `gprai` | Claude: create PR | AI-generated pull request |
| `grai` | Claude: review staged changes | AI code review |

### Aliases vs Functions

- **Aliases** (`cl`, `oc`, `ac`, etc.) are defined in `terminal/zsh/aliases.nix` — simple command mappings
- **Functions** (`clg`, `ocg`, `oc-sops`, `cl-sops`, `qq`, `deep`, `fix`) are defined in `terminal/zsh/default.nix` — needed for env var injection, sops key loading, or multi-line logic

---

## Configuration Architecture

```
ai-agents/
├── default.nix      # Module options, activation scripts, config generation
├── config.nix       # Actual values (models, MCP servers, hooks, settings)
└── log-analyzer.nix # Log analysis tools and dashboard
```

### How It Works

1. **Nix generates** base configs from `config.nix` values
2. **Activation scripts** write configs as real files (not symlinks, so plugins can modify)
3. **`patchAiAgentSecrets`** injects the Z.AI API key into all agents + both OpenCode profiles from sops
4. Agents read their native config files at runtime

---

## Agent Settings

### Claude Code

| Setting | Value | Why |
|---------|-------|-----|
| Model | `opus` | Best quality for primary coding |
| Extended thinking | Always on | Better reasoning by default |
| Auto-updates | `stable` channel | Week-old releases, skips regressions |
| Cleanup | 14 days | Auto-delete old sessions |
| Attribution | Disabled | No auto-attribution in commits/PRs |
| Turn duration | Shown | "Cooked for Xm Ys" feedback |

Permissions allow: `git`, `npm run`, `pnpm`, `bun`, `just`, `nix`. Deny: `rm -rf /`, `.env` files, `./secrets/`.

### OpenCode

| Setting | Value | Why |
|---------|-------|-----|
| Model | `openai/gpt-5.2-codex` | Primary coding model |
| Theme | `gruvbox` | Matches system theme |
| Plugins | oh-my-opencode, antigravity-auth, anthropic-auth | Multi-provider access |

### Gemini CLI

| Setting | Value | Why |
|---------|-------|-----|
| Theme | `Default` | Standard Gemini theme |
| Vim mode | Enabled | Consistent with Neovim workflow |
| Auto-update | Disabled | Nix manages versions |
| Session retention | 30 days | Auto-cleanup old sessions |
| Checkpointing | Enabled | Session recovery on crash |
| Privacy/telemetry | Disabled | Privacy-conscious |
| Tips/banner | Hidden | Clean interface |
| Code execution | Enabled | Run code in sandbox |
| Search grounding | Enabled | Web-grounded responses |

### Codex

| Setting | Value | Why |
|---------|-------|-----|
| Model | `gpt-5.3-codex` | Latest Codex model |
| Personality | `pragmatic` | Direct, practical responses |
| Reasoning effort | `medium` | Balanced speed/quality |
| Approval policy | `on-request` | Model decides when to ask |
| Web search | `live` | Real-time web access |
| Update check | Disabled | Nix manages versions |
| History | `save-all` | Persistent session history |

Trusted projects: `~/System`.

---

## oh-my-opencode Agents (Default Profile)

| Agent | Model | Purpose |
|-------|-------|---------|
| sisyphus | claude-opus-4-6 | Primary orchestrator, delegates work |
| hephaestus | claude-opus-4-6 | Autonomous deep worker |
| oracle | claude-opus-4-6 | Read-only consultant for architecture |
| prometheus | claude-opus-4-6/max | Deep thinking with extended budget |
| metis | claude-opus-4-6 | Pre-planning analysis |
| librarian | claude-sonnet-4-5 | Documentation and reference search |
| atlas | claude-sonnet-4-5 | Codebase exploration |
| momus | gpt-5.2 | Plan review and QA |
| explore | claude-haiku-4-5 | Quick contextual grep |
| multimodal-looker | gemini-3-flash | Visual analysis |

---

## GLM-5 Profile (`ocg` / `clg`)

Z.AI GLM-5 as primary model for cost-effective coding sessions. Two entry points:

### `ocg` — OpenCode with GLM-5

Uses a separate config directory (`~/.config/opencode-glm/`) with all models overridden to GLM variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent | GLM Model | Tier |
|-------|-----------|------|
| sisyphus | zai-coding-plan/glm-5 | Heavy |
| hephaestus | zai-coding-plan/glm-5 | Heavy |
| oracle | zai-coding-plan/glm-5 | Heavy |
| prometheus | zai-coding-plan/glm-5 | Heavy |
| metis | zai-coding-plan/glm-5 | Heavy |
| librarian | zai-coding-plan/glm-4.7 | Standard |
| momus | zai-coding-plan/glm-4.7 | Standard |
| atlas | zai-coding-plan/glm-4.7 | Standard |
| explore | zai-coding-plan/glm-4.7-flash | Fast |
| multimodal-looker | google/gemini-3-flash | Vision (unchanged) |

Category overrides:

| Category | Model |
|----------|-------|
| visual-engineering, ultrabrain, deep, artistry, unspecified-high | glm-5 |
| unspecified-low, writing | glm-4.7 |
| quick | glm-4.7-flash |

### `clg` — Claude Code via Z.AI GLM-5

Routes through Z.AI's Anthropic-compatible proxy (`https://api.z.ai/api/anthropic`).

| Env Var | Value |
|---------|-------|
| `ANTHROPIC_AUTH_TOKEN` | Z.AI API key (from sops) |
| `ANTHROPIC_BASE_URL` | `https://api.z.ai/api/anthropic` |
| `API_TIMEOUT_MS` | `3000000` (50 min, per Z.AI docs) |
| `ANTHROPIC_DEFAULT_HAIKU_MODEL` | `glm-4.5-air` |
| `ANTHROPIC_DEFAULT_SONNET_MODEL` | `glm-5` |
| `ANTHROPIC_DEFAULT_OPUS_MODEL` | `glm-5` |

Also passes `--dangerously-skip-permissions` for autonomous operation.

### GLM Model Reference

| Model ID | Parameters | Context | Use Case |
|----------|-----------|---------|----------|
| glm-5 | 744B (40B active MoE) | 200K | Flagship reasoning |
| glm-4.7 | — | — | Previous gen, stable coding |
| glm-4.7-flash | — | — | Fast/cheap variant |
| glm-4.5-air | — | — | Lightest, haiku tier |
| glm-4.6v | — | — | Vision variant |

Provider prefixes: `zai-coding-plan/` (premium), `zai/` (standard), `opencode/` (free tier).

---

## oh-my-claudecode (Claude Code Plugin)

Installed automatically via activation script. Provides multi-agent orchestration.

### Execution Modes

| Mode | Description |
|------|-------------|
| autopilot | Default automation with safe pacing |
| ultrawork | Aggressive parallel execution |
| ralph | Persistent execution until done |
| ultrapilot | High-agency automation |
| ecomode | Token-efficient execution |
| swarm | Multi-agent style execution |
| pipeline | Sequential pipeline stages |

### Magic Keywords

| Keyword | Meaning |
|---------|---------|
| ultrawork / ulw | Maximum parallelism |
| ralph | Persistent execution until done |
| eco | Token-efficient mode |
| plan | Planning interview |

---

## MCP Servers

Defined once in `config.nix`, shared across Claude Code, OpenCode, Gemini CLI, and Codex.

| Server | Purpose | Status |
|--------|---------|--------|
| context7 | Library documentation context | Enabled (all agents) |
| memory | Persistent knowledge graph across sessions | Enabled (all agents) |
| sequential-thinking | Step-by-step reasoning with backtracking | Enabled (all agents) |
| zai-mcp-server | Z.AI tools (key injected from sops) | Enabled (all agents) |
| playwright | Browser automation and testing | Enabled (all agents) |
| filesystem | Project filesystem access | Enabled (all agents) |
| git | Git repository operations | Enabled (all agents) |
| magic-ui | Magic UI component library | Enabled (all agents) |
| cloudflare-docs | Cloudflare documentation search | Enabled (remote) |
| cloudflare-workers-builds | Cloudflare Workers build tools | Enabled (remote) |
| cloudflare-workers-bindings | Cloudflare Workers bindings | Enabled (remote) |
| cloudflare-observability | Cloudflare observability tools | Enabled (remote) |
| web-search-prime | Web search via Z.AI | Injected at activation |
| web-reader | Read web pages via Z.AI | Injected at activation |
| zread | Document reader via Z.AI | Injected (Claude/OpenCode only) |

Remote MCP servers are injected into all 4 agents by `patchAiAgentSecrets` using the sops-decrypted Z.AI API key.

---

## Claude Code Hooks (Auto-Format)

PostToolUse hooks auto-format files after edits:

| Language | Formatter |
|----------|-----------|
| TypeScript/JavaScript/JSON | biome |
| Rust | rustfmt |
| Zig | zig fmt |
| Go | gofmt |
| Nix | nixfmt |
| Python | ruff format |
| YAML/TOML | prettier |

A PreToolUse hook warns before destructive bash commands (`rm -rf`, `DROP`, `DELETE FROM`, `truncate`).

---

## Sops Secrets Integration

API keys are managed via sops-nix (age-encrypted). The Z.AI API key lives at `/run/secrets/zai_api_key`.

### Shell Functions (sops-enabled)

| Function | What It Does |
|----------|-------------|
| `oc-sops` | Launch OpenCode with Z_AI_API_KEY from sops |
| `cl-sops` | Launch Claude Code with Z_AI_API_KEY from sops |
| `clg` | Claude Code via Z.AI proxy (GLM-5 models + skip-permissions) |
| `ocg` | OpenCode with GLM-5 profile (separate config dir) |

All sops functions use `_load_zai_key()` which reads `/run/secrets/zai_api_key`. If the file is missing, run `just nixos` to decrypt secrets.

### Activation Patching

`just home` runs `patchAiAgentSecrets` which injects the Z.AI API key into:

1. `~/.config/opencode/opencode.json` — MCP server env + remote MCPs
2. `~/.config/opencode-glm/opencode.json` — GLM profile MCP server env + remote MCPs
3. `~/.mcp.json` — Claude Code MCP server env + remote MCPs
4. `~/.codex/config.toml` — MCP server env
5. `~/.gemini/settings.json` — MCP server env + remote MCPs

---

## Logging & Monitoring

### Real Log Locations

| Agent | Log Path |
|-------|----------|
| OpenCode | `~/.local/share/opencode/log/*.log` |
| Codex | `~/.codex/log/codex-tui.log` |
| Claude Code | Enable with `ANTHROPIC_LOG=debug` env var |
| Gemini CLI | No persistent logs by default |

### Commands

| Alias | What It Does |
|-------|-------------|
| `ai-logs` | Tail real OpenCode + Codex logs |
| `ai-errors` | Grep for errors/panics/fatals in agent logs |
| `ai-stats` | Log statistics summary (wrapper-based) |
| `ai-report` | Full analysis report |
| `ai-dash` | Interactive fzf dashboard |

### Wrapper Logging (Optional)

Use `*-log` aliases for explicit logged sessions through the wrapper:

| Alias | Runs |
|-------|------|
| `cl-log` | `ai-agent-log-wrapper claude claude` |
| `oc-log` | `ai-agent-log-wrapper opencode opencode` |
| `codex-log` | `ai-agent-log-wrapper codex codex` |
| `gemini-log` | `ai-agent-log-wrapper gemini gemini` |

Wrapper logs go to `~/.local/share/ai-agents/logs/`. Log cleanup runs weekly (30-day retention) via systemd user timer.

---

## Best Practices

| Practice | Why It Helps |
|----------|--------------|
| Delegate when the task splits cleanly | Reduces context switching and speeds execution |
| Do directly when the task is tightly coupled | Avoids coordination overhead |
| Parallelize independent tasks | Maximizes throughput and reduces total time |
| Keep background tasks running | Useful for long-running fetches or builds |
| Use explicit roles | Prevents overlap and clarifies ownership |

### Quick Patterns

```text
Task is independent?  -> delegate or run in parallel
Task is sequential?   -> keep in a single agent
Need deep analysis?   -> route to prometheus or oracle
Need fast scans?      -> route to explore or atlas
```

### Agent Selection

```text
Simple question       -> claude or gemini (direct)
Coding task           -> claude (opus) or opencode (gpt-5.2-codex)
GLM-5 coding          -> ocg (opencode) or clg (claude code)
Quick prototype       -> codex (pragmatic personality)
Research + docs       -> gemini (search grounding) or librarian agent
Multi-file refactor   -> claude with oh-my-claudecode ultrawork mode
```
