# AI Coding Agents Guide

This guide covers the AI coding agents available in your workflow — configuration, secrets, logging, and orchestration.

---

## Overview

Four CLI tools for AI-assisted development, all configured declaratively via `home-manager/modules/ai-agents/`:

| Agent           | Binary     | Config Location                           | Format |
| --------------- | ---------- | ----------------------------------------- | ------ |
| **Claude Code** | `claude`   | `~/.claude/settings.json` + `~/.mcp.json` | JSON   |
| **OpenCode**    | `opencode` | `~/.config/opencode/opencode.json`        | JSON   |
| **Gemini CLI**  | `gemini`   | `~/.gemini/settings.json`                 | JSON   |
| **Codex**       | `codex`    | `~/.codex/config.toml`                    | TOML   |

All configs are generated by Nix and patched with sops secrets at `just home` activation time.

---

## Shell Aliases & Functions

### Quick Reference

| Alias/Function              | What It Runs                                                       | Notes                                                                |
| --------------------------- | ------------------------------------------------------------------ | -------------------------------------------------------------------- |
| `cl`                        | `claude`                                                           | Default Claude Code interactive session                              |
| `oc`                        | `opencode`                                                         | Default OpenCode                                                     |
| `oc-tmux`                   | OpenCode in tmux with visual multi-agent                           | Function: finds free port, spawns tmux session                       |
| `claude_glm` (`clg`)        | Claude Code via Z.AI GLM-5 proxy                                   | Function: sets ANTHROPIC base URL + GLM model env vars               |
| `opencode_glm` (`ocg`)      | OpenCode with GLM-5 profile                                        | Function: sets `OPENCODE_CONFIG_DIR=~/.config/opencode-glm/`         |
| `opencode_gemini` (`ocgem`) | OpenCode with Gemini Antigravity profile                           | Function: sets `OPENCODE_CONFIG_DIR=~/.config/opencode-gemini/`      |
| `opencode_gpt` (`ocgpt`)    | OpenCode with GPT profile                                          | Function: sets `OPENCODE_CONFIG_DIR=~/.config/opencode-gpt/`         |
| `oc-sops`                   | OpenCode with Z.AI key from sops                                   | Function: injects Z_AI_API_KEY                                       |
| `cl-sops`                   | Claude Code with Z.AI key from sops                                | Function: injects Z_AI_API_KEY                                       |
| `bq`                        | `btca-svelte-ask '<question>'`                                     | Ask better-context about Svelte using your custom question           |
| `occm`                      | `opencode '<review/split/sign prompt>'`                            | Review current git changes and commit logically with `git commit -S` |
| `cx`                        | `codex --no-alt-screen`                                            | Zellij-friendly Codex                                                |
| `cxcm`                      | `codex --no-alt-screen '<review/split/sign prompt>'`               | Review current git changes and commit logically with `git commit -S` |
| `cxyolo`                    | `codex --no-alt-screen --dangerously-bypass-approvals-and-sandbox` | Fully unrestricted Codex (risky)                                     |
| `cxquick`                   | `codex --no-alt-screen -p quick`                                   | Codex quick profile                                                  |
| `cxdeep`                    | `codex --no-alt-screen -p deep`                                    | Codex deep profile                                                   |
| `cxsafe`                    | `codex --no-alt-screen -p safe`                                    | Codex safe profile                                                   |

### Aliases vs Functions

- **Aliases** (`cl`, `oc`, `cx`, `cxquick`, `bq`, `occm`, `cxcm`, etc.) are defined in `home-manager/modules/terminal/zsh/aliases.nix` as simple command mappings.
- **Functions** (`claude_glm`, `opencode_glm`, `opencode_gemini`, `opencode_gpt`, `oc-sops`, `cl-sops`, `oc-tmux`, `btca-svelte-ask`) are defined in `home-manager/modules/terminal/zsh/default.nix` for env var injection, sops key loading, or multi-line logic.

---

## Configuration Architecture

```
ai-agents/
├── default.nix              # Import hub (options, activation, files, services, log-analyzer, config)
├── options.nix              # All programs.aiAgents option definitions
├── _mcp-transforms.nix      # MCP server transform helpers (imported by builders)
├── _settings-builders.nix   # Per-agent settings builders (imported by files.nix)
├── _opencode-profiles.nix   # OpenCode profile names and config paths
├── activation.nix           # Activation scripts (secret patching, config setup, plugin installs)
├── files.nix                # home.file + xdg.configFile declarations
├── services.nix             # Packages, zsh aliases, systemd user services/timers
├── config.nix               # Pass-through to config/ subdirectory
├── config/
│   ├── default.nix          # Import hub
│   ├── agents.nix           # Oh-My-OpenCode agent definitions
│   ├── instructions.nix     # Global instructions + skills
│   ├── mcp-servers.nix      # MCP server definitions + logging
│   ├── models.nix           # Model/provider registries (OpenCode, Codex, Gemini)
│   └── permissions.nix      # Claude permissions, hooks, settings
└── log-analyzer.nix         # Log analysis tools and dashboard
```

### How It Works

1. **Nix generates** base configs from `config.nix` values
2. **Activation scripts** write configs as real files (not symlinks, so plugins can modify)
3. **`patchAiAgentSecrets`** injects the Z.AI API key into all agents + all OpenCode profiles from sops
4. Agents read their native config files at runtime

---

## Agent Settings

### Claude Code

| Setting           | Value            | Why                                                     |
| ----------------- | ---------------- | ------------------------------------------------------- |
| Model             | `opus`           | Best quality for primary coding                         |
| Extended thinking | Always on        | Better reasoning by default                             |
| Tool search       | `auto:5`         | Auto-search when >5 tools match (faster with many MCPs) |
| Auto-updates      | `latest` channel | Fastest release track                                   |
| Cleanup           | 14 days          | Auto-delete old sessions                                |
| Attribution       | Disabled         | No auto-attribution in commits/PRs                      |
| Turn duration     | Shown            | "Cooked for Xm Ys" feedback                             |

Permissions allow: `git`, `gh`, `npm run`, `pnpm`, `bun`, `just`, `nix`, `cargo`, `docker`, etc. Deny: `rm -rf /`, `rm -rf ~`, disk operations (`dd`, `mkfs`), `.env` files, `./secrets/`, SSH keys.

### OpenCode

| Setting         | Value                                            | Why                                                  |
| --------------- | ------------------------------------------------ | ---------------------------------------------------- |
| Model           | `anthropic/claude-opus-4-6`                      | Primary coding model                                 |
| Theme           | `gruvbox`                                        | Matches system theme                                 |
| Small model     | `claude-haiku-4-5`                               | Cheap model for titles, summaries                    |
| Compaction      | Auto + prune                                     | Remove old tool outputs, reserve 10k tokens          |
| Custom commands | test, deploy, review                             | Workflow shortcuts via `/test`, `/deploy`, `/review` |
| Plugins         | oh-my-opencode, antigravity-auth, anthropic-auth | Multi-provider access                                |

### Gemini CLI

| Setting           | Value     | Why                                         |
| ----------------- | --------- | ------------------------------------------- |
| Theme             | `Gruvbox` | Matches system theme                        |
| Vim mode          | Enabled   | Consistent with Neovim workflow             |
| Auto-update       | Enabled   | Keep Gemini CLI current between Nix updates |
| Session retention | 30 days   | Auto-cleanup old sessions                   |
| Checkpointing     | Enabled   | Session recovery on crash                   |
| Privacy/telemetry | Disabled  | Privacy-conscious                           |
| Tips/banner       | Hidden    | Clean interface                             |
| Code execution    | Enabled   | Run code in sandbox                         |
| Search grounding  | Enabled   | Web-grounded responses                      |

### Codex

| Setting                  | Value                          | Why                                                 |
| ------------------------ | ------------------------------ | --------------------------------------------------- |
| Model                    | `gpt-5.3-codex`                | Latest Codex model                                  |
| Personality              | `pragmatic`                    | Direct, practical responses                         |
| Reasoning effort         | `medium`                       | Balanced speed/quality                              |
| Approval policy          | `on-request`                   | Model decides when to ask                           |
| Web search               | `live`                         | Real-time web access                                |
| Update check             | Disabled                       | Nix manages versions                                |
| History                  | `save-all`                     | Persistent session history                          |
| Feature: request_rule    | Enabled                        | Smart approval suggestions                          |
| Feature: child_agents_md | Enabled                        | Honors nested AGENTS instructions in subdirectories |
| Profiles                 | nix, review, quick, deep, safe | Context-switching presets                           |
| Shell env policy         | `core`                         | Exclude secrets/tokens from env                     |

Trusted projects: `~/System`.

---

## oh-my-opencode Agents (Default Profile)

| Agent             | Model               | Purpose                               |
| ----------------- | ------------------- | ------------------------------------- |
| sisyphus          | claude-opus-4-6     | Primary orchestrator, delegates work  |
| hephaestus        | gpt-5.2-codex       | Autonomous deep worker                |
| oracle            | claude-opus-4-6     | Read-only consultant for architecture |
| prometheus        | claude-opus-4-6/max | Deep thinking with extended budget    |
| metis             | claude-opus-4-6     | Pre-planning analysis                 |
| librarian         | claude-sonnet-4-6   | Documentation and reference search    |
| atlas             | claude-sonnet-4-6   | Codebase exploration                  |
| momus             | gpt-5.2             | Plan review and QA                    |
| explore           | claude-haiku-4-5    | Quick contextual grep                 |
| multimodal-looker | gemini-3-flash      | Visual analysis                       |

### oh-my-opencode Category Models

| Category           | Model                      | Use Case                                     |
| ------------------ | -------------------------- | -------------------------------------------- |
| visual-engineering | antigravity-gemini-3-pro   | Frontend, UI/UX, design, styling             |
| ultrabrain         | gpt-5.3-codex              | Deep logical reasoning, complex architecture |
| deep               | claude-opus-4-6 (max)      | Goal-oriented autonomous problem-solving     |
| artistry           | antigravity-gemini-3-pro   | Creative, unconventional approaches          |
| quick              | claude-haiku-4-5           | Trivial tasks, typo fixes                    |
| unspecified-low    | claude-sonnet-4-6          | General tasks, low effort                    |
| unspecified-high   | claude-opus-4-6 (max)      | General tasks, high effort                   |
| writing            | antigravity-gemini-3-flash | Documentation, prose                         |

### oh-my-opencode Features

| Feature                 | Value                               | Why                               |
| ----------------------- | ----------------------------------- | --------------------------------- |
| Tmux visual multi-agent | Enabled                             | See agents work in separate panes |
| Stale task timeout      | 180s                                | Kill hung background tasks        |
| Aggressive truncation   | Enabled                             | Save tokens on large outputs      |
| Preemptive compaction   | Enabled                             | Compact before hitting limits     |
| Disabled hooks          | agent-usage-reminder, startup-toast | Reduce noise                      |

---

## GLM-5 Profile (`opencode_glm` / `claude_glm`)

Z.AI GLM-5 as primary model for cost-effective coding sessions. Two entry points:

### `opencode_glm` (`ocg`) — OpenCode with GLM-5

Uses a separate config directory (`~/.config/opencode-glm/`) with all models overridden to GLM variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent             | GLM Model                     | Tier               |
| ----------------- | ----------------------------- | ------------------ |
| sisyphus          | zai-coding-plan/glm-5         | Heavy              |
| hephaestus        | zai-coding-plan/glm-5         | Heavy              |
| oracle            | zai-coding-plan/glm-5         | Heavy              |
| prometheus        | zai-coding-plan/glm-5         | Heavy              |
| metis             | zai-coding-plan/glm-5         | Heavy              |
| librarian         | zai-coding-plan/glm-4.7       | Standard           |
| momus             | zai-coding-plan/glm-4.7       | Standard           |
| atlas             | zai-coding-plan/glm-4.7       | Standard           |
| explore           | zai-coding-plan/glm-4.7-flash | Fast               |
| multimodal-looker | google/gemini-3-flash         | Vision (unchanged) |

Category overrides:

| Category                                                         | Model         |
| ---------------------------------------------------------------- | ------------- |
| visual-engineering, ultrabrain, deep, artistry, unspecified-high | glm-5         |
| unspecified-low, writing                                         | glm-4.7       |
| quick                                                            | glm-4.7-flash |

### `claude_glm` (`clg`) — Claude Code via Z.AI GLM-5

Routes through Z.AI's Anthropic-compatible proxy (`https://api.z.ai/api/anthropic`).

| Env Var                          | Value                             |
| -------------------------------- | --------------------------------- |
| `ANTHROPIC_AUTH_TOKEN`           | Z.AI API key (from sops)          |
| `ANTHROPIC_BASE_URL`             | `https://api.z.ai/api/anthropic`  |
| `API_TIMEOUT_MS`                 | `3000000` (50 min, per Z.AI docs) |
| `ANTHROPIC_DEFAULT_HAIKU_MODEL`  | `glm-4.5-air`                     |
| `ANTHROPIC_DEFAULT_SONNET_MODEL` | `glm-5`                           |
| `ANTHROPIC_DEFAULT_OPUS_MODEL`   | `glm-5`                           |

Also passes `--dangerously-skip-permissions` for autonomous operation.

### GLM Model Reference

| Model ID      | Parameters            | Context | Use Case                    |
| ------------- | --------------------- | ------- | --------------------------- |
| glm-5         | 744B (40B active MoE) | 200K    | Flagship reasoning          |
| glm-4.7       | —                     | —       | Previous gen, stable coding |
| glm-4.7-flash | —                     | —       | Fast/cheap variant          |
| glm-4.5-air   | —                     | —       | Lightest, haiku tier        |
| glm-4.6v      | —                     | —       | Vision variant              |

Provider prefixes: `zai-coding-plan/` (premium), `zai/` (standard), `opencode/` (free tier).

---

## Gemini Antigravity Profile (`opencode_gemini`)

Google Gemini models via Antigravity as primary models for Gemini-native coding sessions. Uses the `opencode-antigravity-auth` plugin for authentication.

### `opencode_gemini` (`ocgem`) — OpenCode with Gemini Antigravity

Uses a separate config directory (`~/.config/opencode-gemini/`) with all models overridden to Gemini Antigravity variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent             | Gemini Model               | Variant | Tier                   |
| ----------------- | -------------------------- | ------- | ---------------------- |
| sisyphus          | antigravity-gemini-3-pro   | —       | Heavy                  |
| hephaestus        | antigravity-gemini-3-pro   | —       | Heavy                  |
| oracle            | antigravity-gemini-3-pro   | —       | Heavy                  |
| prometheus        | antigravity-gemini-3-pro   | high    | Heavy (max thinking)   |
| metis             | antigravity-gemini-3-pro   | —       | Heavy                  |
| momus             | antigravity-gemini-3-pro   | low     | Heavy (light thinking) |
| librarian         | antigravity-gemini-3-flash | medium  | Fast                   |
| atlas             | antigravity-gemini-3-flash | medium  | Fast                   |
| explore           | antigravity-gemini-3-flash | minimal | Fast (speed priority)  |
| multimodal-looker | gemini-3-flash             | —       | Vision (unchanged)     |

Category overrides:

| Category           | Model                      | Variant |
| ------------------ | -------------------------- | ------- |
| visual-engineering | antigravity-gemini-3-pro   | —       |
| ultrabrain         | antigravity-gemini-3-pro   | high    |
| deep               | antigravity-gemini-3-pro   | high    |
| artistry           | antigravity-gemini-3-pro   | —       |
| unspecified-high   | antigravity-gemini-3-pro   | high    |
| unspecified-low    | antigravity-gemini-3-flash | medium  |
| writing            | antigravity-gemini-3-flash | medium  |
| quick              | antigravity-gemini-3-flash | minimal |

### Gemini Antigravity Model Reference

| Model ID                   | Context | Thinking Variants          | Use Case                                 |
| -------------------------- | ------- | -------------------------- | ---------------------------------------- |
| antigravity-gemini-3-pro   | 1M      | low, high                  | Flagship reasoning, coding, architecture |
| antigravity-gemini-3-flash | 1M      | minimal, low, medium, high | Fast coding, search, writing             |
| gemini-3-flash             | —       | —                          | Vision, multimodal analysis              |

---

## GPT Profile (`opencode_gpt`)

OpenAI GPT models as primary models for GPT-first coding sessions.

### `opencode_gpt` (`ocgpt`) — OpenCode with GPT profile

Uses a separate config directory (`~/.config/opencode-gpt/`) with models overridden to GPT variants. Reuses the same MCP servers, plugins, and permissions as the default profile.

| Agent             | GPT Model             | Tier               |
| ----------------- | --------------------- | ------------------ |
| sisyphus          | openai/gpt-5.3-codex  | Heavy              |
| hephaestus        | openai/gpt-5.3-codex  | Heavy              |
| oracle            | openai/gpt-5.3        | Standard           |
| prometheus        | openai/gpt-5.3-codex  | Heavy              |
| metis             | openai/gpt-5.3-codex  | Heavy              |
| librarian         | openai/gpt-5.3        | Standard           |
| momus             | openai/gpt-5.3        | Standard           |
| atlas             | openai/gpt-5.3        | Standard           |
| explore           | opencode/gpt-5-nano   | Fast               |
| multimodal-looker | google/gemini-3-flash | Vision (unchanged) |

Category overrides:

| Category                                                         | Model                |
| ---------------------------------------------------------------- | -------------------- |
| visual-engineering, ultrabrain, deep, artistry, unspecified-high | openai/gpt-5.3-codex |
| unspecified-low, writing                                         | openai/gpt-5.3       |
| quick                                                            | opencode/gpt-5-nano  |

### GPT Model Reference

| Model ID      | Use Case                             |
| ------------- | ------------------------------------ |
| gpt-5.2-codex | Primary coding and deep execution    |
| gpt-5.2       | Analysis, planning, and review tasks |
| gpt-5-nano    | Fast low-cost exploration            |

Provider prefixes: `openai/` (OpenAI API), `opencode/` (OpenCode hosted/free tier).

---

## oh-my-claudecode (Claude Code Plugin)

Installed automatically via activation script. Provides multi-agent orchestration.

### Execution Modes

| Mode       | Description                         |
| ---------- | ----------------------------------- |
| autopilot  | Default automation with safe pacing |
| ultrawork  | Aggressive parallel execution       |
| ralph      | Persistent execution until done     |
| ultrapilot | High-agency automation              |
| ecomode    | Token-efficient execution           |
| swarm      | Multi-agent style execution         |
| pipeline   | Sequential pipeline stages          |

### Magic Keywords

| Keyword         | Meaning                         |
| --------------- | ------------------------------- |
| ultrawork / ulw | Maximum parallelism             |
| ralph           | Persistent execution until done |
| eco             | Token-efficient mode            |
| plan            | Planning interview              |

---

## MCP Servers

Defined once in `config.nix`, shared across Claude Code, OpenCode, Gemini CLI, and Codex.

| Server              | Purpose                                    | Status                          |
| ------------------- | ------------------------------------------ | ------------------------------- |
| context7            | Library documentation context              | Enabled (all agents)            |
| better-context      | Source-code-grounded library/framework Q&A | Enabled (all agents)            |
| memory              | Persistent knowledge graph across sessions | Enabled (all agents)            |
| sequential-thinking | Step-by-step reasoning with backtracking   | Enabled (all agents)            |
| zai-mcp-server      | Z.AI tools (key injected from sops)        | Enabled (all agents)            |
| playwright          | Browser automation and testing             | Enabled (all agents)            |
| filesystem          | Project filesystem access                  | Enabled (all agents)            |
| git                 | Git repository operations                  | Enabled (all agents)            |
| github              | GitHub API (issues, PRs, code search)      | Enabled (all agents)            |
| cloudflare-docs     | Cloudflare documentation search            | Enabled (remote)                |
| web-search-prime    | Web search via Z.AI                        | Injected at activation          |
| web-reader          | Read web pages via Z.AI                    | Injected at activation          |
| zread               | Document reader via Z.AI                   | Injected (Claude/OpenCode only) |

Remote MCP servers are injected into all 4 agents by `patchAiAgentSecrets` using the sops-decrypted Z.AI API key.

### BTCA Resources

Use `btca add` to register repos/docs you want to query.

```bash
# Generic pattern
btca add -g <git-or-package-or-path> -n <resource-name>

# Ask with your own question text
btca ask --resource <resource-name> --question "Your question here"
```

Examples (already added):

```bash
btca add -g https://github.com/Effect-TS/effect -n effect
btca add -g https://github.com/anomalyco/opencode -n opencode
btca add -g https://github.com/facebook/react -n react
btca add -g https://github.com/honojs/hono -n hono
btca add -g https://github.com/get-convex/convex-backend -n convex
```

---

## BTCA CLI Authentication

btca (better-context) operates in two modes with different auth requirements:

| Mode | Command | Auth Needed | Who Provides AI |
| ---- | ------- | ----------- | --------------- |
| MCP server | `btca mcp` | None | The calling agent (Claude Code, OpenCode, etc.) |
| CLI standalone | `btca ask`, `bs` | Yes | btca calls an AI provider directly |

The MCP server mode always works — it's the agent that pays for inference. The CLI mode (`btca ask`, `bs` alias) needs its own authenticated AI provider.

### Auth Store

btca reads credentials from OpenCode's auth store at `~/.local/share/opencode/auth.json`. Manage credentials with:

```bash
opencode auth list          # Show all authenticated providers
opencode auth login         # Interactive provider selection + auth
opencode auth logout        # Remove credentials
```

### Provider Compatibility

Not all auth types work with btca CLI. Consumer subscription OAuth (Claude Max, ChatGPT Plus) behaves differently from developer API keys:

| Provider | Auth Type | btca CLI Support | Notes |
| -------- | --------- | ---------------- | ----- |
| OpenCode Zen | API key | Yes | Default btca provider; requires billing at opencode.ai |
| OpenAI | OAuth (ChatGPT) | Partial | Only `gpt-5*` models work (Codex endpoint); `gpt-4o*` rejected |
| Anthropic | OAuth (Claude Max) | No | btca needs an API key, not consumer OAuth |
| Anthropic | API key | Yes | From console.anthropic.com; use `opencode auth login` |
| Google | OAuth | No | btca needs AI Studio API key, not Google account OAuth |
| Google | API key | Yes | From aistudio.google.com/api-keys |
| OpenRouter | API key | Yes | From openrouter.ai |
| OpenAI-compat | API key | Yes | Any OpenAI-compatible endpoint (Z.AI, LM Studio, etc.) |

### Recommended Setup (ChatGPT Plus)

If you have ChatGPT Plus, the cheapest working setup:

```bash
btca connect -g -p openai -m gpt-5-codex
```

This routes through the Codex endpoint (`chatgpt.com/backend-api/codex/responses`) which accepts ChatGPT OAuth. Models that work: `gpt-5-codex`, `gpt-5.2-codex`, `gpt-5.2`. Models that fail: `gpt-4o-mini`, `gpt-4o`, `gpt-5-nano` (route to `api.openai.com` which rejects ChatGPT OAuth).

### Config File

btca config lives at `~/.config/btca/btca.config.jsonc` (global) or `.btca/btca.config.jsonc` (project-local). Key fields:

```jsonc
{
  "provider": "openai",        // Provider ID
  "model": "gpt-5-codex",     // Model for CLI queries
  "resources": [ ... ],        // Registered repos/docs
  "providerTimeoutMs": 300000, // 5 min timeout
  "maxSteps": 40               // Max tool-use steps per query
}
```

### Troubleshooting

| Error | Cause | Fix |
| ----- | ----- | --- |
| `Provider "X" is not authenticated` | No credentials for that provider | `opencode auth login` → select provider |
| `Provider "X" is not connected` | OAuth token expired or wrong auth type | Re-auth: `opencode auth login` |
| `model is not supported when using Codex with a ChatGPT account` | Non-Codex model with ChatGPT OAuth | Use `gpt-5-codex` or `gpt-5.2-codex` |
| `No payment method` (OpenCode Zen) | OpenCode Zen needs billing | Add payment at opencode.ai or switch provider |
| `API key not valid` (Google) | Google account OAuth ≠ AI Studio key | Get key from aistudio.google.com |

Check status anytime: `btca status` (shows provider, model, auth state, resources).

---

## Claude Code Hooks (Auto-Format)

PostToolUse hooks auto-format files after edits:

| Language                   | Formatter   |
| -------------------------- | ----------- |
| TypeScript/JavaScript/JSON | biome       |
| Rust                       | rustfmt     |
| Zig                        | zig fmt     |
| Go                         | gofmt       |
| Nix                        | nixfmt      |
| Python                     | ruff format |
| YAML/TOML                  | prettier    |

A PreToolUse hook warns before destructive bash commands (`rm -rf`, `DROP`, `DELETE FROM`, `truncate`).

---

## Sops Secrets Integration

API keys are managed via sops-nix (age-encrypted). The Z.AI API key lives at `/run/secrets/zai_api_key`.

### Shell Functions (sops-enabled)

| Function                    | What It Does                                                   |
| --------------------------- | -------------------------------------------------------------- |
| `oc-sops`                   | Launch OpenCode with Z_AI_API_KEY from sops                    |
| `cl-sops`                   | Launch Claude Code with Z_AI_API_KEY from sops                 |
| `claude_glm` (`clg`)        | Claude Code via Z.AI proxy (GLM-5 models + skip-permissions)   |
| `opencode_glm` (`ocg`)      | OpenCode with GLM-5 profile (separate config dir)              |
| `opencode_gemini` (`ocgem`) | OpenCode with Gemini Antigravity profile (separate config dir) |
| `opencode_gpt` (`ocgpt`)    | OpenCode with GPT profile (separate config dir)                |

All sops functions use `_load_zai_key()` which reads `/run/secrets/zai_api_key`. If the file is missing, run `just nixos` to decrypt secrets.

### Activation Patching

`just home` runs `patchAiAgentSecrets` which injects the Z.AI API key into:

1. `~/.config/opencode/opencode.json` — MCP server env + remote MCPs
2. `~/.config/opencode-glm/opencode.json` — GLM profile MCP server env + remote MCPs
3. `~/.config/opencode-gemini/opencode.json` — Gemini profile MCP server env + remote MCPs
4. `~/.config/opencode-gpt/opencode.json` — GPT profile MCP server env + remote MCPs
5. `~/.mcp.json` — Claude Code MCP server env + remote MCPs
6. `~/.codex/config.toml` — MCP server env
7. `~/.gemini/settings.json` — MCP server env + remote MCPs

---

## Logging & Monitoring

### Real Log Locations

| Agent       | Log Path                                  |
| ----------- | ----------------------------------------- |
| OpenCode    | `~/.local/share/opencode/log/*.log`       |
| Codex       | `~/.codex/log/codex-tui.log`              |
| Claude Code | Enable with `ANTHROPIC_LOG=debug` env var |
| Gemini CLI  | No persistent logs by default             |

### Commands

| Alias       | What It Does                                |
| ----------- | ------------------------------------------- |
| `ai-logs`   | Tail real OpenCode + Codex logs             |
| `ai-errors` | Grep for errors/panics/fatals in agent logs |
| `ai-stats`  | Log statistics summary (wrapper-based)      |
| `ai-report` | Full analysis report                        |
| `ai-dash`   | Interactive fzf dashboard                   |

### Wrapper Logging (Optional)

Use `*-log` aliases for explicit logged sessions through the wrapper:

| Alias        | Runs                                     |
| ------------ | ---------------------------------------- |
| `cl-log`     | `ai-agent-log-wrapper claude claude`     |
| `oc-log`     | `ai-agent-log-wrapper opencode opencode` |
| `codex-log`  | `ai-agent-log-wrapper codex codex`       |
| `gemini-log` | `ai-agent-log-wrapper gemini gemini`     |

Wrapper logs go to `~/.local/share/ai-agents/logs/`. Log cleanup runs weekly (30-day retention) via systemd user timer.

---

## Best Practices

| Practice                                     | Why It Helps                                   |
| -------------------------------------------- | ---------------------------------------------- |
| Delegate when the task splits cleanly        | Reduces context switching and speeds execution |
| Do directly when the task is tightly coupled | Avoids coordination overhead                   |
| Parallelize independent tasks                | Maximizes throughput and reduces total time    |
| Keep background tasks running                | Useful for long-running fetches or builds      |
| Use explicit roles                           | Prevents overlap and clarifies ownership       |

### Quick Patterns

```text
Task is independent?  -> delegate or run in parallel
Task is sequential?   -> keep in a single agent
Need deep analysis?   -> route to prometheus or oracle
Need fast scans?      -> route to explore or atlas
```

### Agent Selection

```text
Simple question       -> claude or gemini (direct)
Coding task           -> claude (opus) or opencode (gpt-5.2-codex)
GLM-5 coding          -> opencode_glm (alias: ocg) or claude_glm (alias: clg)
Gemini coding         -> opencode_gemini (alias: ocgem)
GPT coding            -> opencode_gpt (alias: ocgpt)
Codex profiles        -> cxquick (fast), cxdeep (thorough), cxsafe (guard-railed)
Quick prototype       -> codex (pragmatic personality)
Research + docs       -> gemini (search grounding) or librarian agent
Multi-file refactor   -> claude with oh-my-claudecode ultrawork mode
```
