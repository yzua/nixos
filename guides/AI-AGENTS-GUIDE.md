# AI Coding Agents Guide

This guide covers the AI coding agents available in your workflow — configuration, secrets, logging, and orchestration.

---

## Overview

Four CLI tools for AI-assisted development, all configured declaratively via `home-manager/modules/ai-agents/`:

| Agent | Binary | Config Location | Format |
|-------|--------|----------------|--------|
| **Claude Code** | `claude` | `~/.claude/settings.json` + `~/.mcp.json` | JSON |
| **OpenCode** | `opencode` | `~/.config/opencode/opencode.json` | JSON |
| **Gemini CLI** | `gemini` | `~/.gemini/settings.json` | JSON |
| **Codex** | `codex` | `~/.codex/config.toml` | TOML |

All configs are generated by Nix and patched with sops secrets at `just home` activation time.

---

## Configuration Architecture

```
ai-agents/
├── default.nix      # Module options, activation scripts, config generation
├── config.nix       # Actual values (models, MCP servers, hooks, settings)
└── log-analyzer.nix # Log analysis tools and dashboard
```

### How It Works

1. **Nix generates** base configs from `config.nix` values
2. **Activation scripts** write configs as real files (not symlinks, so plugins can modify)
3. **`patchAiAgentSecrets`** injects the Z.AI API key into all 4 agents from sops
4. Agents read their native config files at runtime

---

## Agent Settings

### Claude Code

| Setting | Value | Why |
|---------|-------|-----|
| Model | `opus` | Best quality for primary coding |
| Extended thinking | Always on | Better reasoning by default |
| Auto-updates | `stable` channel | Week-old releases, skips regressions |
| Cleanup | 14 days | Auto-delete old sessions |
| Attribution | Disabled | No auto-attribution in commits/PRs |
| Turn duration | Shown | "Cooked for Xm Ys" feedback |

Permissions allow: `git`, `npm run`, `pnpm`, `bun`, `just`, `nix`. Deny: `rm -rf /`, `.env` files, `./secrets/`.

### OpenCode

| Setting | Value | Why |
|---------|-------|-----|
| Model | `openai/gpt-5.2-codex` | Primary coding model |
| Theme | `gruvbox` | Matches system theme |
| Plugins | oh-my-opencode, antigravity-auth, anthropic-auth | Multi-provider access |

### Gemini CLI

| Setting | Value | Why |
|---------|-------|-----|
| Theme | `Default` | Standard Gemini theme |
| Vim mode | Enabled | Consistent with Neovim workflow |
| Auto-update | Disabled | Nix manages versions |
| Session retention | 30 days | Auto-cleanup old sessions |
| Checkpointing | Enabled | Session recovery on crash |
| Privacy/telemetry | Disabled | Privacy-conscious |
| Tips/banner | Hidden | Clean interface |
| Code execution | Enabled | Run code in sandbox |
| Search grounding | Enabled | Web-grounded responses |

### Codex

| Setting | Value | Why |
|---------|-------|-----|
| Model | `gpt-5.3-codex` | Latest Codex model |
| Personality | `pragmatic` | Direct, practical responses |
| Reasoning effort | `medium` | Balanced speed/quality |
| Approval policy | `on-request` | Model decides when to ask |
| Web search | `live` | Real-time web access |
| Update check | Disabled | Nix manages versions |
| History | `save-all` | Persistent session history |

Trusted projects: `~/System`.

---

## oh-my-opencode Agents

| Agent | Model | Purpose |
|-------|-------|---------|
| sisyphus | claude-opus-4-6 | Primary orchestrator, delegates work |
| oracle | claude-opus-4-6 | Read-only consultant for architecture |
| librarian | claude-sonnet-4-5 | Documentation and reference search |
| atlas | claude-sonnet-4-5 | Codebase exploration |
| explore | claude-haiku-4-5 | Quick contextual grep |
| metis | claude-opus-4-6 | Pre-planning analysis |
| prometheus | claude-opus-4-6/max | Deep thinking with extended budget |
| momus | gpt-5.2 | Plan review and QA |
| multimodal-looker | gemini-3-flash | Visual analysis |

---

## oh-my-claudecode (Claude Code Plugin)

Installed automatically via activation script. Provides multi-agent orchestration.

### Execution Modes

| Mode | Description |
|------|-------------|
| autopilot | Default automation with safe pacing |
| ultrawork | Aggressive parallel execution |
| ralph | Persistent execution until done |
| ultrapilot | High-agency automation |
| ecomode | Token-efficient execution |
| swarm | Multi-agent style execution |
| pipeline | Sequential pipeline stages |

### Magic Keywords

| Keyword | Meaning |
|---------|---------|
| ultrawork / ulw | Maximum parallelism |
| ralph | Persistent execution until done |
| eco | Token-efficient mode |
| plan | Planning interview |

---

## MCP Servers

Defined once in `config.nix`, shared across Claude Code, OpenCode, Gemini CLI, and Codex.

| Server | Purpose | Status |
|--------|---------|--------|
| context7 | Library documentation context | Enabled (all agents) |
| memory | Persistent knowledge graph across sessions | Enabled (all agents) |
| sequential-thinking | Step-by-step reasoning with backtracking | Enabled (all agents) |
| zai-mcp-server | Z.AI tools (key injected from sops) | Enabled (all agents) |
| playwright | Browser automation and testing | Enabled (all agents) |
| cloudflare-docs | Cloudflare documentation search | Enabled (remote) |
| cloudflare-workers-builds | Cloudflare Workers build tools | Enabled (remote) |
| cloudflare-workers-bindings | Cloudflare Workers bindings | Enabled (remote) |
| cloudflare-observability | Cloudflare observability tools | Enabled (remote) |
| magic-ui | Magic UI component library | Enabled (all agents) |
| web-search-prime | Web search via Z.AI | Injected at activation |
| web-reader | Read web pages via Z.AI | Injected at activation |
| zread | Document reader via Z.AI | Injected (Claude/OpenCode only) |
| filesystem | Project filesystem access | Disabled |

Remote MCP servers are injected into all 4 agents by `patchAiAgentSecrets` using the sops-decrypted Z.AI API key.

---

## Claude Code Hooks (Auto-Format)

PostToolUse hooks auto-format files after edits:

| Language | Formatter |
|----------|-----------|
| TypeScript/JavaScript/JSON | biome |
| Rust | rustfmt |
| Zig | zig fmt |
| Go | gofmt |
| Nix | nixfmt |
| Python | ruff format |
| YAML/TOML | prettier |

A PreToolUse hook warns before destructive bash commands (`rm -rf`, `DROP`, `DELETE FROM`, `truncate`).

---

## Sops Secrets Integration

API keys are managed via sops-nix (age-encrypted). The Z.AI API key lives at `/run/secrets/zai_api_key`.

### Shell Wrappers (zsh functions)

| Function | What It Does |
|----------|-------------|
| `oc-sops` | Launch OpenCode with Z_AI_API_KEY from sops |
| `cl-sops` | Launch Claude Code with Z_AI_API_KEY from sops |
| `clg` | Claude Code via Z.AI proxy (ANTHROPIC_BASE_URL + skip-permissions) |

These are defined as **zsh functions** (not aliases) in `terminal/zsh/default.nix` so they properly pass arguments via `$@`.

### Activation Patching

`just home` runs `patchAiAgentSecrets` which injects the Z.AI API key into:

1. `~/.config/opencode/opencode.json` — MCP server env + remote MCPs
2. `~/.mcp.json` — Claude Code MCP server env + remote MCPs
3. `~/.codex/config.toml` — MCP server env
4. `~/.gemini/settings.json` — MCP server env + remote MCPs

---

## Logging & Monitoring

### Real Log Locations

| Agent | Log Path |
|-------|----------|
| OpenCode | `~/.local/share/opencode/log/*.log` |
| Codex | `~/.codex/log/codex-tui.log` |
| Claude Code | Enable with `ANTHROPIC_LOG=debug` env var |
| Gemini CLI | No persistent logs by default |

### Commands

| Alias | What It Does |
|-------|-------------|
| `ai-logs` | Tail real OpenCode + Codex logs |
| `ai-errors` | Grep for errors/panics/fatals in agent logs |
| `ai-stats` | Log statistics summary (wrapper-based) |
| `ai-report` | Full analysis report |
| `ai-dash` | Interactive fzf dashboard |

### Wrapper Logging (Optional)

Use `*-log` aliases for explicit logged sessions through the wrapper:

| Alias | Runs |
|-------|------|
| `cl-log` | `ai-agent-log-wrapper claude claude` |
| `oc-log` | `ai-agent-log-wrapper opencode opencode` |
| `codex-log` | `ai-agent-log-wrapper codex codex` |
| `gemini-log` | `ai-agent-log-wrapper gemini gemini` |

Wrapper logs go to `~/.local/share/ai-agents/logs/`. Log cleanup runs weekly (30-day retention) via systemd user timer.

---

## Best Practices

| Practice | Why It Helps |
|----------|--------------|
| Delegate when the task splits cleanly | Reduces context switching and speeds execution |
| Do directly when the task is tightly coupled | Avoids coordination overhead |
| Parallelize independent tasks | Maximizes throughput and reduces total time |
| Keep background tasks running | Useful for long-running fetches or builds |
| Use explicit roles | Prevents overlap and clarifies ownership |

### Quick Patterns

```text
Task is independent?  -> delegate or run in parallel
Task is sequential?   -> keep in a single agent
Need deep analysis?   -> route to prometheus or oracle
Need fast scans?      -> route to explore or atlas
```

### Agent Selection

```text
Simple question       -> claude or gemini (direct)
Coding task           -> claude (opus) or opencode (gpt-5.2-codex)
Quick prototype       -> codex (pragmatic personality)
Research + docs       -> gemini (search grounding) or librarian agent
Multi-file refactor   -> claude with oh-my-claudecode ultrawork mode
```
